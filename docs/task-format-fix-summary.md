# Task Format Compatibility Fix - Summary

## Problem

The `skf dag` command was unable to parse tasks.md files generated by `/speckit.tasks` because of a format mismatch:

- **Parser expected**: `- [ ] [T001] [deps:] Task description` (task ID in brackets)
- **Template generated**: `- [ ] T001 Task description` (task ID without brackets)

This caused `skf dag` to report "No tasks found in tasks.md" even when tasks existed.

## Root Cause

The `speckit_core.tasks.py` parser uses a regex pattern that requires task IDs to be enclosed in brackets: `[T###]`. However, the task template and command instructions were generating task IDs without brackets: `T###`.

## Solution

**CRITICAL**: Template changes alone are not sufficient. Since `specify init` downloads templates from GitHub releases, we must also update the repository source.

### 1. Changed Repository Source

Updated `src/specify_cli/__init__.py` to pull templates from the fixed repository:

```python
# Before:
repo_owner = "github"
repo_name = "spec-kit"

# After:
repo_owner = "dscv103"
repo_name = "spec-kit-flow"
```

This ensures users get the corrected templates with bracketed task IDs when running `specify init`.

### 2. Updated Templates

Fixed all task examples in:
- `templates/tasks-template.md` - All sample tasks now use `[T###]` format
- `templates/commands/tasks.md` - Instructions now specify bracketed format requirement

**Changes:**
```diff
- - [ ] T001 Create project structure
+ - [ ] [T001] Create project structure

- - [ ] T005 [P] Implement authentication
+ - [ ] [T005] [P] Implement authentication

- - [ ] T012 [P] [US1] Create User model
+ - [ ] [T012] [P] [US1] Create User model
```

### 2. Enhanced Documentation

Updated command instructions to emphasize the bracketed format:

```markdown
**Format Components**:
1. Checkbox: ALWAYS start with `- [ ]`
2. Task ID: MUST be in brackets: [T001], [T002], [T003]
   ⚠️ CRITICAL: Brackets are REQUIRED for skf dag parser compatibility
3. [P] marker: Optional parallelizable flag
4. [Story] label: Optional user story reference
```

Added clear examples of correct vs incorrect formats.

### 3. Improved Error Messages

Enhanced CLI error messages to be more helpful when no tasks are found:

**Before:**
```
Warning: No tasks found in tasks.md

The tasks file exists but contains no parseable tasks.
Ensure tasks follow the format:
  - [ ] [T001] [deps:] Task description
```

**After:**
```
Warning: No tasks found in tasks.md

The tasks file exists but contains no parseable tasks.
Ensure tasks follow the format:
  - [ ] [T001] [deps:] Task description

Common issues:
  • Task IDs must be in brackets: [T001] not T001
  • Task IDs must have exactly 3 digits: [T001] not [T1]
  • Lines must start with checkbox: - [ ] or - [x]

To fix existing tasks.md:
  sed -i -E 's/^(- \[[x ]\] )T([0-9]{3})\b/\1[T\2]/' tasks.md

Or regenerate with:
  /speckit.tasks # In your AI agent

See docs/task-format-migration.md for detailed migration guide
```

### 4. Migration Guide

Created `docs/task-format-migration.md` with:
- Explanation of the format requirement
- Automated migration command (sed one-liner)
- Manual migration examples
- Troubleshooting common errors
- Complete format specification

### 5. README Updates

Updated README.md to:
- Clearly document the bracketed format requirement
- Add warning about format compatibility
- Emphasize using `/speckit.tasks` for auto-generation

## Testing

To verify the fix works:

1. **Generate new tasks** using updated template:
   ```bash
   # In AI agent
   /speckit.tasks
   ```

2. **Verify parsing works**:
   ```bash
   skf dag --visualize
   ```

3. **Migrate existing tasks** (if needed):
   ```bash
   sed -i -E 's/^(- \[[x ]\] )T([0-9]{3})\b/\1[T\2]/' specs/your-feature/tasks.md
   skf dag --visualize
   ```

## Impact

### Users with Existing Projects

If you have tasks.md files created before this fix:
- Tasks will not parse with `skf dag` 
- Use the migration guide to fix format
- Or regenerate tasks.md with `/speckit.tasks`

### New Projects

- `/speckit.tasks` now generates correct format automatically
- `skf dag` will parse tasks successfully
- No manual fixes needed

## Files Changed

1. **`src/specify_cli/__init__.py`** - **CRITICAL**: Changed template source from `github/spec-kit` to `dscv103/spec-kit-flow`
2. `templates/tasks-template.md` - Fixed all task ID examples
3. `templates/commands/tasks.md` - Updated format specification and instructions
4. `src/speckit_flow/__init__.py` - Enhanced error messages (2 locations)
5. `README.md` - Added format warnings and clarifications
6. `docs/task-format-migration.md` - New migration guide (created)

## Future Considerations

### Fork Maintenance

Since we've forked from `github/spec-kit` to `dscv103/spec-kit-flow`:

**Pros:**
- Can release fixes immediately without upstream approval
- Full control over template format and structure
- Can add SpecKitFlow-specific enhancements

**Cons:**
- Must maintain our own release pipeline
- Need to sync beneficial changes from upstream
- Users must know to use dscv103 version

**Alternative**: Could contribute these changes back to `github/spec-kit` to benefit the broader community.

### Option 1: Make Parser More Lenient

Could update `src/speckit_core/tasks.py` to accept both formats:
- `[T001]` (bracketed - current requirement)
- `T001` (unbracketed - add support)

**Pros:** Backward compatible with old tasks.md files
**Cons:** Less strict, harder to distinguish task IDs from other text

### Option 2: Keep Current Strict Format

Current approach (chosen for this fix):
- Clear, unambiguous format
- Easy to parse reliably
- Forces consistency across projects
- Migration path provided for existing files

## Related Issues

This fix addresses the core issue reported:
```
Warning: No tasks found in tasks.md
Unexpected error: 1
```

The solution ensures seamless integration between:
- `/speckit.tasks` (specify CLI command)
- `skf dag` (SpecKitFlow command)

## Next Steps for Users

1. **For new features**: Just use `/speckit.tasks` - it now generates correct format
2. **For existing features**: Run migration command or regenerate tasks.md
3. **For questions**: See docs/task-format-migration.md
4. **For issues**: Report at https://github.com/dscv103/spec-kit-flow/issues

## Deployment Requirements

For this fix to work for end users:

1. **Create GitHub Release**: Must create a release in `dscv103/spec-kit-flow` with template ZIPs
   - Release packages must follow naming: `spec-kit-template-{agent}-{script-type}-{version}.zip`
   - Templates in the ZIP must have the corrected format

2. **Users Must Reinstall**: Users need to get the updated `specify` CLI:
   ```bash
   # Update the CLI that now points to dscv103 repo
   uv tool install specify-cli --force --from git+https://github.com/dscv103/spec-kit-flow.git
   ```

3. **Existing Projects**: Still need migration (one-time):
   ```bash
   sed -i -E 's/^(- \[[x ]\] )T([0-9]{3})\b/\1[T\2]/' specs/*/tasks.md
   ```

4. **New Projects**: Will automatically get correct format

## Validation

After applying these changes, the workflow should be:

```bash
# 1. Generate tasks with correct format
/speckit.tasks

# 2. Parse successfully
skf dag --visualize
# Output: ✓ Parsed X tasks from tasks.md

# 3. Run orchestration
skf init --sessions 3
skf run
```

No format errors, no migration needed for new projects.
